# yaml-language-server: $schema=https://aka.ms/configuration-dsc-schema/0.2
# Scott Hanselman's Dev Machine Setup
properties:
  configurationVersion: 0.2.0
  resources:

# Creates a Dev Drive on D: (50GB, ReFS)
    - resource: Disk
      id: DevDrive
      directives:
        module: StorageDsc
        description: 'Create Dev Drive on D:'
        allowPrerelease: true
      settings:
        DiskId: '0'
        DiskIdType: 'Number'
        DriveLetter: 'D'
        FSLabel: 'Dev Drive'
        DevDrive: true
        AllowDestructive: true
        FSFormat: 'ReFS'
        Size: '50Gb'

# Git and GitHub tools
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: git
      directives:
        description: Install Git
        allowPrerelease: true
      settings:
        id: Git.Git
        source: winget

    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: githubcli
      dependsOn:
        - git
      directives:
        description: Install GitHub CLI
        allowPrerelease: true
      settings:
        id: GitHub.cli
        source: winget

    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: githubcopilot
      dependsOn:
        - githubcli
      directives:
        description: Install GitHub Copilot CLI
        allowPrerelease: true
      settings:
        id: GitHub.copilot
        source: winget

# Editors
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: vscode
      directives:
        description: Install VS Code
        allowPrerelease: true
      settings:
        id: Microsoft.VisualStudioCode
        source: winget

    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: vscodeinsiders
      directives:
        description: Install VS Code Insiders
        allowPrerelease: true
      settings:
        id: Microsoft.VisualStudioCode.Insiders
        source: winget

    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: visualstudio
      directives:
        description: Install Visual Studio 2026 Community
        allowPrerelease: true
      settings:
        id: Microsoft.VisualStudio.Community
        source: winget

    - resource: PSDscResources/Script
      id: visualstudioworkloads
      dependsOn:
        - visualstudio
      directives:
        description: Configure Visual Studio workloads from .vsconfig
        allowPrerelease: true
      settings:
        GetScript: |
          @{ Result = $true }
        TestScript: |
          return $false
        SetScript: |
          $vsConfigUrl = "https://raw.githubusercontent.com/shanselman/wingetdevsetup/master/.vsconfig"
          $vsConfigPath = "$env:TEMP\.vsconfig"
          Invoke-WebRequest -Uri $vsConfigUrl -OutFile $vsConfigPath
          $vsInstallerPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vs_installer.exe"
          if (Test-Path $vsInstallerPath) {
            & $vsInstallerPath modify --installPath "${env:ProgramFiles}\Microsoft Visual Studio\2026\Community" --config $vsConfigPath --quiet
          }

# Runtimes and SDKs
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: dotnet
      directives:
        description: Install .NET SDK 10
        allowPrerelease: true
      settings:
        id: Microsoft.DotNet.SDK.Preview
        source: winget

    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: nvm
      directives:
        description: Install NVM for Windows
        allowPrerelease: true
      settings:
        id: CoreyButler.NVMforWindows
        source: winget

    - resource: PSDscResources/Script
      id: nvmsetup
      dependsOn:
        - nvm
      directives:
        description: Install and use Node LTS via NVM
        allowPrerelease: true
      settings:
        GetScript: |
          @{ Result = Test-Path "$env:ProgramFiles\nodejs" }
        TestScript: |
          return $false
        SetScript: |
          # Refresh PATH to pick up NVM
          $env:NVM_HOME = "$env:LOCALAPPDATA\nvm"
          $env:PATH = "$env:NVM_HOME;$env:PATH"
          & "$env:NVM_HOME\nvm.exe" install lts
          & "$env:NVM_HOME\nvm.exe" use lts

    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: python
      directives:
        description: Install Python 3
        allowPrerelease: true
      settings:
        id: Python.Python.3.12
        source: winget

# Containers
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: docker
      directives:
        description: Install Docker Desktop
        allowPrerelease: true
      settings:
        id: Docker.DockerDesktop
        source: winget

# Terminal and Shell
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: windowsterminal
      directives:
        description: Install Windows Terminal
        allowPrerelease: true
      settings:
        id: Microsoft.WindowsTerminal
        source: winget

    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: powershell
      directives:
        description: Install PowerShell 7
        allowPrerelease: true
      settings:
        id: Microsoft.PowerShell
        source: winget

    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: ohmyposh
      directives:
        description: Install Oh My Posh
        allowPrerelease: true
      settings:
        id: JanDeDobbeleer.OhMyPosh
        source: winget

# WSL and Linux
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: wsl
      directives:
        description: Install WSL
        allowPrerelease: true
      settings:
        id: Microsoft.WSL
        source: winget

    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: ubuntu
      dependsOn:
        - wsl
      directives:
        description: Install Ubuntu
        allowPrerelease: true
      settings:
        id: Canonical.Ubuntu.2404
        source: winget

# Create the github folder structure
    - resource: PSDscResources/Script
      id: CreateGitHubFolder
      dependsOn:
        - DevDrive
        - git
      directives:
        description: Create D:\github folder
        allowPrerelease: true
      settings:
        GetScript: |
          @{ Result = Test-Path 'D:\github' }
        TestScript: |
          Test-Path 'D:\github'
        SetScript: |
          New-Item -Path 'D:\github' -ItemType Directory -Force

# Windows Settings
    - resource: Microsoft.Windows.Developer/WindowsExplorer
      directives:
        description: Show file extensions in Explorer
        allowPrerelease: true
      settings:
        FileExtensions: Show

    - resource: Microsoft.Windows.Developer/Taskbar
      directives:
        description: Hide widgets from taskbar
        allowPrerelease: true
      settings:
        WidgetsButton: Hide

# Daily Apps
    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: 1password
      directives:
        description: Install 1Password
        allowPrerelease: true
      settings:
        id: AgileBits.1Password
        source: winget

    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: powertoys
      directives:
        description: Install PowerToys
        allowPrerelease: true
      settings:
        id: Microsoft.PowerToys
        source: winget

    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: windowsapp
      directives:
        description: Install Windows App (Remote Desktop)
        allowPrerelease: true
      settings:
        id: 9N1F85V9T8BN
        source: msstore

    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: filepilot
      directives:
        description: Install FilePilot
        allowPrerelease: true
      settings:
        id: Voidstar.FilePilot
        source: winget

    - resource: Microsoft.WinGet.DSC/WinGetPackage
      id: gsudo
      directives:
        description: Install gsudo
        allowPrerelease: true
      settings:
        id: gerardog.gsudo
        source: winget

    - resource: PSDscResources/Script
      id: handy
      directives:
        description: Install Handy from GitHub releases
        allowPrerelease: true
      settings:
        GetScript: |
          @{ Result = Test-Path "$env:LOCALAPPDATA\Programs\Handy\Handy.exe" }
        TestScript: |
          Test-Path "$env:LOCALAPPDATA\Programs\Handy\Handy.exe"
        SetScript: |
          $latestRelease = Invoke-RestMethod -Uri "https://api.github.com/repos/cjpais/Handy/releases/latest"
          $asset = $latestRelease.assets | Where-Object { $_.name -like "*_x64-setup.exe" } | Select-Object -First 1
          if ($asset) {
            $installerPath = "$env:TEMP\Handy-Setup.exe"
            Invoke-WebRequest -Uri $asset.browser_download_url -OutFile $installerPath
            Start-Process -FilePath $installerPath -ArgumentList "/S" -Wait
            Remove-Item $installerPath -Force
          }

# PowerShell Profile and Oh My Posh setup
    - resource: PSDscResources/Script
      id: SetupPowerShellProfile
      dependsOn:
        - powershell
        - ohmyposh
        - windowsterminal
      directives:
        description: Setup PowerShell profile and Oh My Posh theme
        allowPrerelease: true
      settings:
        GetScript: |
          $pwsh7ProfilePath = "$env:USERPROFILE\Documents\PowerShell\Microsoft.PowerShell_profile.ps1"
          @{ Result = Test-Path $pwsh7ProfilePath }
        TestScript: |
          return $false
        SetScript: |
          try {
            $repoBase = "https://raw.githubusercontent.com/shanselman/wingetdevsetup/master"
            
            # Setup PowerShell 7 profile
            $pwsh7ProfilePath = "$env:USERPROFILE\Documents\PowerShell\Microsoft.PowerShell_profile.ps1"
            $pwsh7ProfileDir = Split-Path $pwsh7ProfilePath -Parent
            if (!(Test-Path $pwsh7ProfileDir)) {
                New-Item -Path $pwsh7ProfileDir -ItemType Directory -Force | Out-Null
            }
            Invoke-WebRequest -Uri "$repoBase/Microsoft.PowerShell_profile.ps1" -OutFile $pwsh7ProfilePath
            
            # Setup Windows PowerShell 5.1 profile too
            $winPSProfilePath = "$env:USERPROFILE\Documents\WindowsPowerShell\Microsoft.PowerShell_profile.ps1"
            $winPSProfileDir = Split-Path $winPSProfilePath -Parent
            if (!(Test-Path $winPSProfileDir)) {
                New-Item -Path $winPSProfileDir -ItemType Directory -Force | Out-Null
            }
            Invoke-WebRequest -Uri "$repoBase/Microsoft.PowerShell_profile.ps1" -OutFile $winPSProfilePath
            
            # Install required PowerShell modules for the profile
            # Use PowerShell 7 to install modules in its module path
            $pwsh7Path = "$env:ProgramFiles\PowerShell\7\pwsh.exe"
            if (Test-Path $pwsh7Path) {
              Write-Host "Installing PowerShell modules for profile..."
              # Create a temp script to run in PowerShell 7
              $scriptLines = @(
                "Import-Module PowerShellGet -Force -ErrorAction Stop",
                "Set-PSRepository -Name PSGallery -InstallationPolicy Trusted",
                "Install-Module -Name Terminal-Icons -Force -Scope CurrentUser",
                "Install-Module -Name z -Force -Scope CurrentUser -AllowClobber",
                "Write-Output 'Modules installed successfully'"
              )
              $tempScript = "$env:TEMP\install-ps-modules.ps1"
              $scriptLines -join "`n" | Out-File -FilePath $tempScript -Encoding UTF8 -Force
              & $pwsh7Path -NoProfile -ExecutionPolicy Bypass -File $tempScript
              Remove-Item $tempScript -Force -ErrorAction SilentlyContinue
            } else {
              Write-Warning "PowerShell 7 not found at $pwsh7Path - skipping module installation"
            }
            
            # Download Oh My Posh theme
            $ompThemePath = "$env:USERPROFILE\hanselman.$env:COMPUTERNAME.omp.json"
            Invoke-WebRequest -Uri "$repoBase/hanselman.omp.json" -OutFile $ompThemePath
            
            # Install CascadiaCode Nerd Font
            & oh-my-posh font install CascadiaCode
            
            # Configure Windows Terminal to use the font
            $wtSettingsPath = "$env:LOCALAPPDATA\Packages\Microsoft.WindowsTerminal_8wekyb3d8bbwe\LocalState\settings.json"
            if (Test-Path $wtSettingsPath) {
                $settings = Get-Content $wtSettingsPath -Raw | ConvertFrom-Json
                if (-not $settings.profiles.defaults) {
                    $settings.profiles | Add-Member -NotePropertyName "defaults" -NotePropertyValue @{} -Force
                }
                $settings.profiles.defaults | Add-Member -NotePropertyName "font" -NotePropertyValue @{ face = "CaskaydiaCove NF" } -Force
                $settings | ConvertTo-Json -Depth 10 | Set-Content $wtSettingsPath
            }
          } catch {
            Write-Error "Error in SetupPowerShellProfile: $_"
            throw
          }
